<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5-Point Discernment</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>My Issues</h1>
    <button id="addIssueBtn">＋</button>
  </header>

  <main id="view"></main>

  <template id="issue-list-template">
    <ul id="issueList"></ul>
  </template>

  <template id="issue-detail-template">
    <button id="backBtn">← Back</button>
    <h2 id="issueTitle"></h2>
    <input id="titleInput" placeholder="Issue title" />
    <ol id="questions"></ol>
    <details>
      <summary>Reminders</summary>
      <label>
        Frequency
        <select id="frequency">
          <option value="none">None</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
          <option value="yearly">Yearly</option>
        </select>
      </label>
      <label>
        Time of day
        <input type="time" id="reminderTime" value="09:00" />
      </label>
    </details>
    <button id="saveBtn">Save</button>
  </template>

  <script src="app.js"></script>
</body>
</html>

<!-- style.css -->
body { font-family: system-ui, sans-serif; margin: 0; padding: 0 1rem; }
header { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; }
button { font-size: 1.2rem; padding: 0.4rem 0.8rem; }
ul { list-style: none; padding: 0; }
li { margin: 0.5rem 0; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; }
input, textarea, select { width: 100%; margin: 0.3rem 0 1rem; padding: 0.5rem; font-size: 1rem; }
textarea { min-height: 80px; }

<!-- manifest.json -->
{
  "name": "5-Point Discernment Tool",
  "short_name": "Discern",
  "start_url": "./index.html",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0a84ff",
  "icons": [
    { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}

<!-- service-worker.js -->
self.addEventListener('install', e => {
  e.waitUntil(caches.open('discern-cache').then(c => c.addAll([
    './',
    './index.html',
    './style.css',
    './app.js',
    './manifest.json'
  ])));
});

self.addEventListener('fetch', e => {
  e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
});

/* Periodic reminder check (simplified) */
self.addEventListener('periodicsync', async e => {
  if (e.tag === 'check-reminders') {
    const dbData = await self.registration.storage.get('issues');
    // iterate issues and show notifications if due (implementation left minimal)
  }
});

<!-- app.js -->
const QUESTIONS = [
  'What do my circumstances suggest?',
  'How do I sense the Spirit directing me?',
  'What do my counselors advise?',
  'What do I hear from God in prayer?',
  'What does God\'s Word say?'
];

const STORAGE_KEY = 'issues';
const view = document.getElementById('view');
const addIssueBtn = document.getElementById('addIssueBtn');

// --- Models and Persistence ---
function loadIssues() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}
function saveIssues(issues) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(issues));
}
function upsertIssue(issue) {
  const issues = loadIssues();
  const i = issues.findIndex(x => x.id === issue.id);
  if (i >= 0) issues[i] = issue; else issues.unshift(issue);
  saveIssues(issues);
}

// --- UI Renderers ---
function renderList() {
  const template = document.getElementById('issue-list-template');
  view.innerHTML = template.innerHTML;
  const ul = document.getElementById('issueList');
  const issues = loadIssues();
  issues.forEach(issue => {
    const li = document.createElement('li');
    li.textContent = issue.title || '(Untitled Issue)';
    li.onclick = () => renderDetail(issue.id);
    ul.appendChild(li);
  });
}

function renderDetail(issueId) {
  let issue = loadIssues().find(x => x.id === issueId) || {
    id: crypto.randomUUID(),
    title: '',
    answers: ['', '', '', '', ''],
    createdAt: Date.now(),
    updatedAt: Date.now(),
    reminderFrequency: 'none',
    reminderTime: '09:00'
  };

  const template = document.getElementById('issue-detail-template');
  view.innerHTML = template.innerHTML;

  const titleEl = document.getElementById('titleInput');
  const listEl = document.getElementById('questions');
  const freqEl = document.getElementById('frequency');
  const timeEl = document.getElementById('reminderTime');

  titleEl.value = issue.title;
  freqEl.value = issue.reminderFrequency;
  timeEl.value = issue.reminderTime;

  QUESTIONS.forEach((q, i) => {
    const li = document.createElement('li');
    const label = document.createElement('label');
    label.textContent = q;
    const ta = document.createElement('textarea');
    ta.value = issue.answers[i];
    ta.oninput = e => issue.answers[i] = e.target.value;
    li.append(label, ta);
    listEl.appendChild(li);
  });

  document.getElementById('saveBtn').onclick = () => {
    issue.title = titleEl.value;
    issue.reminderFrequency = freqEl.value;
    issue.reminderTime = timeEl.value;
    issue.updatedAt = Date.now();
    upsertIssue(issue);
    renderList();
  };

  document.getElementById('backBtn').onclick = renderList;
}

// --- Initialisation ---
window.addEventListener('load', () => {
  renderList();
});

addIssueBtn.onclick = () => renderDetail();

// --- PWA Installation Prompt ---
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e; // You could show an "Install" button
});

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
